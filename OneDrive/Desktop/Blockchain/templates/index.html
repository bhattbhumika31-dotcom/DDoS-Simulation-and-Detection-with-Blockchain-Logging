<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDoS Shield: Simulation & Detection Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and scrollbar styling for a console aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a1a2e; color: #e9e9f2; }
        .console-bg { background-color: #162447; border: 1px solid #4a5c9d; }
        .log-container { font-family: 'Space Mono', monospace; font-size: 0.8rem; height: 400px; overflow-y: scroll; scrollbar-color: #4a5c9d #162447; }
        .log-container::-webkit-scrollbar { width: 8px; }
        .log-container::-webkit-scrollbar-thumb { background-color: #4a5c9d; border-radius: 4px; }
        .log-container::-webkit-scrollbar-track { background-color: #162447; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .running { background-color: #38c172; }
        .stopped { background-color: #e3342f; }
        .unknown { background-color: #ffed4a; }
        .valid { background-color: #38c172; }
        .invalid { background-color: #e3342f; }
        .text-attack { color: #f66d9b; }
        .text-normal { color: #6cb2eb; }
        .text-detection { color: #ffed4a; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                DDoS Shield: Simulation & Detection
            </h1>
            <p class="text-gray-400 mt-2">Team Lead: Bhumika Bhatt | Logging: Manasi Sharma | Detection: Mansi Kabdal | Simulation: Saachi Aggarwal</p>
        </header>

        <!-- Control Panel -->
        <section class="console-bg p-6 rounded-lg shadow-2xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-300 border-b border-gray-600 pb-2">Control Panel</h2>
            <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
                
                <!-- Start Buttons -->
                <div class="flex space-x-3 w-full md:w-auto">
                    <button id="start-normal-btn" onclick="controlSimulation('start', 'normal')"
                            class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg transition duration-200 shadow-md disabled:opacity-50">
                        Start Normal Traffic
                    </button>
                    <button id="start-attack-btn" onclick="controlSimulation('start', 'attack')"
                            class="flex-1 px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition duration-200 shadow-md disabled:opacity-50">
                        Start DDoS Attack
                    </button>
                </div>
                
                <!-- Stop Button -->
                <button id="stop-btn" onclick="controlSimulation('stop')"
                        class="w-full md:w-auto px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition duration-200 shadow-md disabled:opacity-50">
                    Stop Simulation
                </button>
            </div>
            <p id="message-box" class="mt-4 text-center font-bold"></p>
        </section>

        <!-- Status and Metrics Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- System Status -->
            <section class="console-bg p-6 rounded-lg shadow-xl">
                <h2 class="text-xl font-semibold mb-4 text-cyan-300">System Status</h2>
                <ul class="space-y-3">
                    <li class="flex justify-between items-center">
                        <span>Backend Server:</span>
                        <span id="server-status" class="font-bold">
                            <span class="status-dot unknown"></span> Unknown
                        </span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span>Traffic Simulation:</span>
                        <span id="simulation-status" class="font-bold">
                            <span class="status-dot unknown"></span> Unknown
                        </span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span>Attack Mode:</span>
                        <span id="attack-mode" class="font-bold text-gray-300">N/A</span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span>Server Address:</span>
                        <span id="server-address" class="font-bold text-gray-400 text-sm">N/A</span>
                    </li>
                </ul>
            </section>
            
            <!-- Blockchain Log Integrity -->
            <section class="console-bg p-6 rounded-lg shadow-xl">
                <h2 class="text-xl font-semibold mb-4 text-cyan-300">Log Integrity (Manasi Sharma)</h2>
                <ul class="space-y-3">
                    <li class="flex justify-between items-center">
                        <span>Log Chain Length:</span>
                        <span id="log-length" class="font-bold text-gray-300">0</span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span>Chain Status:</span>
                        <span id="log-chain-valid" class="font-bold">
                            <span class="status-dot unknown"></span> Pending
                        </span>
                    </li>
                    <li class="col-span-2">
                        <span class="text-sm text-gray-500">Validation Message:</span>
                        <p id="validation-msg" class="text-xs break-words text-gray-400 mt-1"></p>
                    </li>
                </ul>
            </section>

            <!-- Evaluation Metrics -->
            <section class="console-bg p-6 rounded-lg shadow-xl">
                <h2 class="text-xl font-semibold mb-4 text-cyan-300">Detection Metrics (Evaluation Module)</h2>
                <ul class="space-y-3">
                    <li class="flex justify-between items-center">
                        <span>True Positive (TP):</span>
                        <span id="metric-tp" class="font-bold text-green-400">N/A</span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span>False Positive (FP):</span>
                        <span id="metric-fp" class="font-bold text-red-400">N/A</span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span>Accuracy:</span>
                        <span id="metric-accuracy" class="font-bold text-yellow-400">N/A</span>
                    </li>
                    <li class="flex justify-between items-center">
                        <span>Total Requests:</span>
                        <span id="metric-total" class="font-bold text-gray-300">N/A</span>
                    </li>
                </ul>
            </section>
        </div>

        <!-- Real-Time Log Console -->
        <section class="console-bg p-6 rounded-lg shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-300 border-b border-gray-600 pb-2">Real-Time Traffic Log (Manasi Sharma & Mansi Kabdal)</h2>
            <div id="log-console" class="log-container p-3 rounded-lg bg-black/50">
                <table class="w-full text-left table-fixed">
                    <thead>
                        <tr class="bg-gray-800 sticky top-0">
                            <th class="w-1/6 p-2 text-cyan-300">Time</th>
                            <th class="w-1/6 p-2 text-cyan-300">IP</th>
                            <th class="w-1/6 p-2 text-cyan-300">Detection</th>
                            <th class="w-1/2 p-2 text-cyan-300">Block Hash</th>
                        </tr>
                    </thead>
                    <tbody id="log-entries">
                        <!-- Log entries will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const API_STATUS = '/api/status';
        const API_LOGS = '/api/logs';
        const API_METRICS = '/api/metrics';
        const API_CONTROL = '/api/simulation';

        // Helper function for fetching data
        const fetchData = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${url}:`, error);
                document.getElementById('message-box').textContent = `Connection error: Could not reach Flask server.`;
                document.getElementById('message-box').className = 'mt-4 text-center font-bold text-red-400';
                return null;
            }
        };

        // --- Status Update ---
        const updateStatus = (data) => {
            if (!data) return;

            // Server Status
            const serverStatusEl = document.getElementById('server-status');
            serverStatusEl.innerHTML = `<span class="status-dot ${data.server_status === 'Running' ? 'running' : 'stopped'}"></span> ${data.server_status}`;
            document.getElementById('server-address').textContent = data.server_address;

            // Simulation Status and Button State
            const simStatusEl = document.getElementById('simulation-status');
            const simRunning = data.simulation_status === 'Running';
            simStatusEl.innerHTML = `<span class="status-dot ${simRunning ? 'running' : 'stopped'}"></span> ${data.simulation_status}`;
            
            document.getElementById('start-normal-btn').disabled = simRunning;
            document.getElementById('start-attack-btn').disabled = simRunning;
            document.getElementById('stop-btn').disabled = !simRunning;
            
            document.getElementById('attack-mode').textContent = data.attack_mode ? 'ATTACK' : 'NORMAL';
            document.getElementById('attack-mode').className = `font-bold ${data.attack_mode ? 'text-red-400' : 'text-green-400'}`;


            // Log Integrity Status
            const logValidEl = document.getElementById('log-chain-valid');
            const validationMsgEl = document.getElementById('validation-msg');
            const logLengthEl = document.getElementById('log-length');

            logLengthEl.textContent = data.log_length;

            if (data.log_chain_valid) {
                logValidEl.innerHTML = `<span class="status-dot valid"></span> VALID`;
                logValidEl.className = 'font-bold text-green-400';
            } else {
                logValidEl.innerHTML = `<span class="status-dot invalid"></span> INVALID`;
                logValidEl.className = 'font-bold text-red-400';
            }
            validationMsgEl.textContent = data.log_validation_message || 'Chain is healthy.';
        };
        
        // --- Metrics Update ---
        const updateMetrics = (data) => {
            if (!data) return;

            document.getElementById('metric-tp').textContent = data.true_positives !== undefined ? data.true_positives : 'N/A';
            document.getElementById('metric-fp').textContent = data.false_positives !== undefined ? data.false_positives : 'N/A';
            document.getElementById('metric-total').textContent = data.total_requests !== undefined ? data.total_requests : 'N/A';

            const accuracyText = data.accuracy !== undefined ? (data.accuracy * 100).toFixed(2) + '%' : 'N/A';
            document.getElementById('metric-accuracy').textContent = accuracyText;
        }

        // --- Log Update ---
        const updateLogs = (data) => {
            if (!data || !data.logs) return;

            const logTable = document.getElementById('log-entries');
            logTable.innerHTML = ''; // Clear previous logs
            
            // Reverse the array to show the newest logs at the top (like a console)
            const logs = data.logs.slice().reverse(); 

            logs.forEach(log => {
                const row = logTable.insertRow();
                
                // Format timestamp
                const date = new Date(log.timestamp * 1000);
                const timeString = date.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', second:'2-digit', hour12: false});
                
                // Determine CSS class based on detection result
                let statusClass = '';
                let statusText = log.detection_status;

                if (log.detection_status === 'attack') {
                    statusClass = 'text-attack';
                } else if (log.detection_status === 'normal') {
                    statusClass = 'text-normal';
                } else if (log.detection_status === 'detected') {
                     statusClass = 'text-detection';
                }

                row.insertCell().textContent = timeString;
                row.insertCell().textContent = log.ip || 'N/A';
                row.insertCell().innerHTML = `<span class="${statusClass} font-bold uppercase">${statusText}</span>`;
                row.insertCell().textContent = log.hash ? log.hash.substring(0, 12) + '...' : 'N/A';

                // Apply console row styling
                row.className = 'hover:bg-gray-700/50 transition duration-100 border-b border-gray-800';
                row.cells[0].className = 'p-2 text-gray-400';
                row.cells[1].className = 'p-2 text-gray-300';
                row.cells[2].className = 'p-2';
                row.cells[3].className = 'p-2 text-xs text-gray-500 truncate';
            });
        };

        // --- Core Fetch Loop ---
        const refreshDashboard = async () => {
            await Promise.all([
                fetchData(API_STATUS).then(updateStatus),
                fetchData(API_LOGS).then(updateLogs),
                fetchData(API_METRICS).then(updateMetrics)
            ]);
        };

        // --- Simulation Control ---
        const controlSimulation = async (action, mode = null) => {
            const endpoint = `${API_CONTROL}/${action}${mode ? '/' + mode : ''}`;
            
            document.getElementById('message-box').textContent = `Sending '${action}' request...`;
            document.getElementById('message-box').className = 'mt-4 text-center font-bold text-yellow-400';

            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();
                
                document.getElementById('message-box').textContent = result.message;
                document.getElementById('message-box').className = 'mt-4 text-center font-bold ' + (response.ok ? 'text-green-400' : 'text-red-400');
            } catch (error) {
                console.error('Error controlling simulation:', error);
                document.getElementById('message-box').textContent = 'An error occurred during control command.';
                document.getElementById('message-box').className = 'mt-4 text-center font-bold text-red-400';
            }
            
            // Force status update after control command
            setTimeout(refreshDashboard, 500); 
        };

        // Initialize dashboard and set up polling
        window.onload = () => {
            // Poll for updates every 1.5 seconds
            setInterval(refreshDashboard, 1500); 
            refreshDashboard(); 
        };
    </script>
</body>
</html>
